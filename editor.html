<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickChart Template Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { padding: 1rem; background-color: #f5f5f5; }
    .editor-container { max-width: 1400px; margin: 0 auto; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .editor-header h1 { margin: 0; font-size: 1.5rem; }
    .editor-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .editor-tabs .btn { border-radius: 0.5rem 0.5rem 0 0; }
    .editor-tabs .btn.active { background-color: #fff; border-bottom-color: #fff; position: relative; z-index: 1; }
    .editor-panel { background: #fff; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; display: none; }
    .editor-panel.active { display: block; }
    .section-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
    .section-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; cursor: move; }
    .section-card-header h5 { margin: 0; display: flex; align-items: center; gap: 0.5rem; }
    .section-card-header .drag-handle { cursor: move; color: #6c757d; }
    .sentence-item { background: #fff; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.75rem; margin-bottom: 0.5rem; position: relative; }
    .sentence-item-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .sentence-item .drag-handle { cursor: move; color: #6c757d; margin-right: 0.5rem; }
    .sentence-text { font-family: monospace; font-size: 0.875rem; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.5rem; word-break: break-word; }
    .tab-item { background: #e9ecef; border-radius: 0.25rem; padding: 0.5rem; margin-bottom: 0.25rem; }
    .dropdown-option-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; }
    .dropdown-option-item input { flex: 1; }
    .syntax-helper { background: #e7f3ff; border: 1px solid #b6d4fe; border-radius: 0.25rem; padding: 0.75rem; margin-bottom: 1rem; }
    .syntax-helper code { background: #fff; padding: 0.125rem 0.25rem; border-radius: 0.125rem; }
    .insert-btn { font-size: 0.75rem; padding: 0.125rem 0.5rem; }
    .preview-text { font-family: monospace; font-size: 0.875rem; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; white-space: pre-wrap; word-break: break-word; max-height: 200px; overflow-y: auto; }
    .common-sentence-item { background: #fff; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.75rem; margin-bottom: 0.5rem; }
    .badge-incremental { background-color: #198754; }
    .badge-tabbed { background-color: #0d6efd; }
    .badge-quicksentence { background-color: #6f42c1; }
    .badge-hidden { background-color: #6c757d; }
    .collapse-content { margin-top: 0.75rem; }
    .json-preview { font-family: monospace; font-size: 0.75rem; max-height: 400px; overflow: auto; white-space: pre; background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.25rem; }
    [data-bs-theme="dark"] { background-color: #121212; color: #e0e0e0; }
    [data-bs-theme="dark"] .editor-panel, [data-bs-theme="dark"] .section-card, [data-bs-theme="dark"] .sentence-item, [data-bs-theme="dark"] .common-sentence-item { background-color: #1e1e1e; border-color: #333; }
    [data-bs-theme="dark"] .section-card { background-color: #2a2a2a; }
    [data-bs-theme="dark"] .sentence-text, [data-bs-theme="dark"] .preview-text { background-color: #333; color: #e0e0e0; }
    [data-bs-theme="dark"] .syntax-helper { background-color: #1a3a5c; border-color: #2d5a8c; }
    [data-bs-theme="dark"] .tab-item { background-color: #333; }
    [data-bs-theme="dark"] .form-control, [data-bs-theme="dark"] .form-select { background-color: #2a2a2a; color: #e0e0e0; border-color: #444; }
    /* Ensure modals are hidden by default */
    .modal { display: none; }
    .modal.show { display: block; background-color: rgba(0,0,0,0.5); }
    .modal-backdrop { display: none; }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="editor-header">
      <h1><i class="bi bi-pencil-square me-2"></i>QuickChart Template Editor</h1>
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-secondary btn-sm" id="darkModeToggle" title="Toggle dark mode">
          <i class="bi bi-moon-fill"></i>
        </button>
        <button class="btn btn-outline-primary btn-sm" id="importBtn">
          <i class="bi bi-upload me-1"></i>Import JSON
        </button>
        <button class="btn btn-primary btn-sm" id="exportBtn">
          <i class="bi bi-download me-1"></i>Export JSON
        </button>
        <a href="index.html" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Back to QuickChart
        </a>
      </div>
    </div>
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <!-- Editor Tabs -->
    <div class="editor-tabs">
      <button class="btn btn-outline-secondary active" data-tab="sections">
        <i class="bi bi-layout-text-sidebar me-1"></i>Sections
      </button>
      <button class="btn btn-outline-secondary" data-tab="global-sentences">
        <i class="bi bi-chat-square-text me-1"></i>Global Sentences
      </button>
      <button class="btn btn-outline-secondary" data-tab="local-dropdowns">
        <i class="bi bi-list-ul me-1"></i>Local Dropdowns
      </button>
      <button class="btn btn-outline-secondary" data-tab="global-dropdowns">
        <i class="bi bi-globe me-1"></i>Global Dropdowns
      </button>
      <button class="btn btn-outline-secondary" data-tab="preview">
        <i class="bi bi-eye me-1"></i>Preview JSON
      </button>
    </div>

    <!-- Syntax Helper -->
    <div class="syntax-helper">
      <strong><i class="bi bi-lightbulb me-1"></i>Syntax Reference:</strong>
      <div class="row mt-2">
        <div class="col-md-4">
          <small>
            <code>[text:Label]</code> - Text input<br>
            <code>[number:Label]</code> - Number input<br>
            <code>[customDropdown:Label]</code> - Dropdown
          </small>
        </div>
        <div class="col-md-4">
          <small>
            <code>[customDropdown:Label:opt1,opt2]</code> - Inline options<br>
            <code>+</code> prefix - Incremental sentence<br>
            <code>++</code> prefix - Incremental with newlines
          </small>
        </div>
        <div class="col-md-4">
          <small>
            <code>[+content]</code> - Incremental block<br>
            <code>*</code> prefix on option - Hidden by default<br>
            <code>\n</code> - Line break in output
          </small>
        </div>
      </div>
    </div>

    <!-- Sections Panel -->
    <div class="editor-panel active" id="sections-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Narrative Sections</h4>
        <button class="btn btn-success btn-sm" id="addSectionBtn">
          <i class="bi bi-plus-lg me-1"></i>Add Section
        </button>
      </div>
      <div id="sectionsContainer"></div>
    </div>

    <!-- Global Sentences Panel -->
    <div class="editor-panel" id="global-sentences-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Global Sentences (commonSentences)</h4>
        <button class="btn btn-success btn-sm" id="addGlobalSentenceBtn">
          <i class="bi bi-plus-lg me-1"></i>Add Global Sentence
        </button>
      </div>
      <p class="text-muted small">These sentences are available in the "Add Sentence" search across all sections. They are stored in global.json.</p>
      <div id="globalSentencesContainer"></div>
    </div>

    <!-- Local Dropdowns Panel -->
    <div class="editor-panel" id="local-dropdowns-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Local Dropdown Options</h4>
        <button class="btn btn-success btn-sm" id="addLocalDropdownBtn">
          <i class="bi bi-plus-lg me-1"></i>Add Dropdown
        </button>
      </div>
      <p class="text-muted small">These dropdown options are specific to this template and override global options with the same name.</p>
      <div id="localDropdownsContainer"></div>
    </div>

    <!-- Global Dropdowns Panel -->
    <div class="editor-panel" id="global-dropdowns-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Global Dropdown Options</h4>
        <button class="btn btn-success btn-sm" id="addGlobalDropdownBtn">
          <i class="bi bi-plus-lg me-1"></i>Add Dropdown
        </button>
      </div>
      <p class="text-muted small">These dropdown options are shared across all templates. They are stored in global.json.</p>
      <div id="globalDropdownsContainer"></div>
    </div>

    <!-- Preview Panel -->
    <div class="editor-panel" id="preview-panel">
      <h4 class="mb-3">JSON Preview</h4>
      <div class="row">
        <div class="col-md-6">
          <h5>Template JSON (e.g., default.json)</h5>
          <div class="json-preview" id="templateJsonPreview"></div>
        </div>
        <div class="col-md-6">
          <h5>Global JSON (global.json)</h5>
          <div class="json-preview" id="globalJsonPreview"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Section Modal -->
  <div class="modal fade" id="sectionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sectionModalTitle">Add Section</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Part (Main Title) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="sectionPart" placeholder="e.g., D, C, H, A, R, T, M">
            <small class="text-muted">The main letter/title that appears in bold</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Subpart (Title Extension)</label>
            <input type="text" class="form-control" id="sectionSubpart" placeholder="e.g., ispatch:, hief Complaint:">
            <small class="text-muted">The rest of the title (appears lighter)</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Tooltip</label>
            <input type="text" class="form-control" id="sectionTooltip" placeholder="Description shown on hover">
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="sectionIncludeTitle" checked>
            <label class="form-check-label" for="sectionIncludeTitle">Include title in output</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveSectionBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Sentence Modal -->
  <div class="modal fade" id="sentenceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sentenceModalTitle">Add Sentence</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3" id="sentenceTypeTabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#simpleTab">Simple Text</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabbedTab">Tabbed</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#quickTab">QuickSentence</button>
            </li>
          </ul>
          <div class="tab-content">
            <!-- Simple Text Tab -->
            <div class="tab-pane fade show active" id="simpleTab">
              <div class="mb-3">
                <label class="form-label">Sentence Text</label>
                <textarea class="form-control" id="sentenceText" rows="4" placeholder="Enter sentence text with placeholders..."></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Insert Placeholder:</label>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[text:Label]">Text Input</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[number:Label]">Number Input</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[customDropdown:Label]">Dropdown</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[customDropdown:Label:option1,option2]">Dropdown w/Options</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[+]">Incremental Block</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="\\n">Line Break</button>
                </div>
              </div>
              <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="sentenceIncremental">
                <label class="form-check-label" for="sentenceIncremental">
                  Make incremental (can add multiple instances)
                </label>
              </div>
              <div class="form-check mb-3" id="incrementalNewlineOption" style="display: none;">
                <input type="checkbox" class="form-check-input" id="sentenceIncrementalNewline">
                <label class="form-check-label" for="sentenceIncrementalNewline">
                  Separate instances with newlines (++ instead of +)
                </label>
              </div>
            </div>
            <!-- Tabbed Tab -->
            <div class="tab-pane fade" id="tabbedTab">
              <div id="tabsEditor">
                <div class="mb-3">
                  <button class="btn btn-outline-success btn-sm" id="addTabBtn">
                    <i class="bi bi-plus-lg me-1"></i>Add Tab
                  </button>
                </div>
                <div id="tabsContainer"></div>
              </div>
            </div>
            <!-- QuickSentence Tab -->
            <div class="tab-pane fade" id="quickTab">
              <div class="mb-3">
                <label class="form-label">QuickSentence Name</label>
                <input type="text" class="form-control" id="quickSentenceName" placeholder="e.g., IV Access, Ventilator">
                <small class="text-muted">This should match the name of a Global Sentence</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveSentenceBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Global Sentence Modal -->
  <div class="modal fade" id="globalSentenceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="globalSentenceModalTitle">Add Global Sentence</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Name (for QuickSentence reference)</label>
            <input type="text" class="form-control" id="globalSentenceName" placeholder="e.g., IV Access, GCS">
            <small class="text-muted">Used to reference this sentence in QuickSentence placeholders</small>
          </div>
          <ul class="nav nav-tabs mb-3" id="globalSentenceTypeTabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#globalSimpleTab">Simple Text</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#globalTabbedTab">Tabbed</button>
            </li>
          </ul>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="globalSimpleTab">
              <div class="mb-3">
                <label class="form-label">Sentence Text</label>
                <textarea class="form-control" id="globalSentenceText" rows="4" placeholder="Enter sentence text..."></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Insert Placeholder:</label>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[text:Label]" data-target="globalSentenceText">Text Input</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[number:Label]" data-target="globalSentenceText">Number Input</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[customDropdown:Label]" data-target="globalSentenceText">Dropdown</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[customDropdown:Label:option1,option2]" data-target="globalSentenceText">Dropdown w/Options</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="[+]" data-target="globalSentenceText">Incremental Block</button>
                  <button class="btn btn-outline-secondary insert-btn" data-insert="\\n" data-target="globalSentenceText">Line Break</button>
                </div>
              </div>
              <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="globalSentenceIncremental">
                <label class="form-check-label" for="globalSentenceIncremental">Make incremental</label>
              </div>
              <div class="form-check mb-3" id="globalIncrementalNewlineOption" style="display: none;">
                <input type="checkbox" class="form-check-input" id="globalSentenceIncrementalNewline">
                <label class="form-check-label" for="globalSentenceIncrementalNewline">Separate with newlines (++)</label>
              </div>
            </div>
            <div class="tab-pane fade" id="globalTabbedTab">
              <div class="mb-3">
                <button class="btn btn-outline-success btn-sm" id="addGlobalTabBtn">
                  <i class="bi bi-plus-lg me-1"></i>Add Tab
                </button>
              </div>
              <div id="globalTabsContainer"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveGlobalSentenceBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Dropdown Modal -->
  <div class="modal fade" id="dropdownModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dropdownModalTitle">Add Dropdown</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Dropdown Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="dropdownName" placeholder="e.g., Unit #, Provider, Gender">
            <small class="text-muted">Use this name in [customDropdown:Name] placeholders</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Options</label>
            <div id="dropdownOptionsContainer"></div>
            <button class="btn btn-outline-success btn-sm mt-2" id="addDropdownOptionBtn">
              <i class="bi bi-plus-lg me-1"></i>Add Option
            </button>
          </div>
          <div class="alert alert-info small">
            <i class="bi bi-info-circle me-1"></i>
            Prefix an option with <code>*</code> to hide it by default (shown when user types to filter)
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveDropdownBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==================== STATE ====================
    let templateData = {
      localDropdownOptions: {},
      narrativeSections: []
    };
    
    let globalData = {
      commonSentences: [],
      globalDropdownOptions: {}
    };

    let editingIndex = null;
    let editingSectionIndex = null;
    let editingDropdownType = null;
    let editingDropdownName = null;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      initializeDarkMode();
      initializeTabs();
      initializeModals();
      initializeImportExport();
      renderAll();
    });

    function initializeDarkMode() {
      const toggle = document.getElementById('darkModeToggle');
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) {
        document.documentElement.setAttribute('data-bs-theme', 'dark');
        toggle.innerHTML = '<i class="bi bi-sun-fill"></i>';
      }
      toggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        toggle.innerHTML = newTheme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
        localStorage.setItem('darkMode', newTheme === 'dark');
      });
    }

    function initializeTabs() {
      document.querySelectorAll('.editor-tabs .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.editor-tabs .btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab + '-panel').classList.add('active');
          if (btn.dataset.tab === 'preview') updatePreview();
        });
      });
    }

    function initializeModals() {
      // Section modal
      document.getElementById('addSectionBtn').addEventListener('click', () => openSectionModal());
      document.getElementById('saveSectionBtn').addEventListener('click', saveSection);

      // Sentence modal
      document.getElementById('saveSentenceBtn').addEventListener('click', saveSentence);
      document.getElementById('addTabBtn').addEventListener('click', () => addTabToEditor('tabsContainer'));
      document.getElementById('sentenceIncremental').addEventListener('change', (e) => {
        document.getElementById('incrementalNewlineOption').style.display = e.target.checked ? 'block' : 'none';
      });

      // Global sentence modal
      document.getElementById('addGlobalSentenceBtn').addEventListener('click', () => openGlobalSentenceModal());
      document.getElementById('saveGlobalSentenceBtn').addEventListener('click', saveGlobalSentence);
      document.getElementById('addGlobalTabBtn').addEventListener('click', () => addTabToEditor('globalTabsContainer'));
      document.getElementById('globalSentenceIncremental').addEventListener('change', (e) => {
        document.getElementById('globalIncrementalNewlineOption').style.display = e.target.checked ? 'block' : 'none';
      });

      // Dropdown modals
      document.getElementById('addLocalDropdownBtn').addEventListener('click', () => openDropdownModal('local'));
      document.getElementById('addGlobalDropdownBtn').addEventListener('click', () => openDropdownModal('global'));
      document.getElementById('saveDropdownBtn').addEventListener('click', saveDropdown);
      document.getElementById('addDropdownOptionBtn').addEventListener('click', addDropdownOption);

      // Insert buttons
      document.querySelectorAll('.insert-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.target || 'sentenceText';
          const textarea = document.getElementById(target);
          const insert = btn.dataset.insert;
          insertAtCursor(textarea, insert);
        });
      });
    }

    function initializeImportExport() {
      document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('importFile').click();
      });

      document.getElementById('importFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            // Detect if it's a global.json or template json
            if (data.commonSentences || (data.globalDropdownOptions && !data.narrativeSections)) {
              globalData = {
                commonSentences: data.commonSentences || [],
                globalDropdownOptions: data.globalDropdownOptions || {}
              };
              alert('Global configuration imported successfully!');
            } else {
              templateData = {
                localDropdownOptions: data.localDropdownOptions || {},
                narrativeSections: data.narrativeSections || []
              };
              alert('Template configuration imported successfully!');
            }
            renderAll();
          } catch (err) {
            alert('Error parsing JSON: ' + err.message);
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        const templateJson = JSON.stringify(templateData, null, 2);
        const globalJson = JSON.stringify(globalData, null, 2);
        
        // Create download for template
        downloadJson(templateData, 'template.json');
        
        // Ask if user wants to download global too
        if (globalData.commonSentences.length > 0 || Object.keys(globalData.globalDropdownOptions).length > 0) {
          if (confirm('Do you also want to download the global.json file?')) {
            setTimeout(() => downloadJson(globalData, 'global.json'), 500);
          }
        }
      });
    }

    function downloadJson(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ==================== RENDERING ====================
    function renderAll() {
      renderSections();
      renderGlobalSentences();
      renderLocalDropdowns();
      renderGlobalDropdowns();
      updatePreview();
    }

    function renderSections() {
      const container = document.getElementById('sectionsContainer');
      container.innerHTML = '';
      
      templateData.narrativeSections.forEach((section, sectionIndex) => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.dataset.index = sectionIndex;
        
        card.innerHTML = `
          <div class="section-card-header">
            <h5>
              <span class="drag-handle"><i class="bi bi-grip-vertical"></i></span>
              <strong>${escapeHtml(section.part)}</strong>${section.subpart ? `<span class="text-muted">${escapeHtml(section.subpart)}</span>` : ''}
              ${section.tooltip ? `<small class="text-muted ms-2" title="${escapeHtml(section.tooltip)}"><i class="bi bi-info-circle"></i></small>` : ''}
            </h5>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="openSectionModal(${sectionIndex})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-success" onclick="openSentenceModal(${sectionIndex})"><i class="bi bi-plus-lg"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteSection(${sectionIndex})"><i class="bi bi-trash"></i></button>
            </div>
          </div>
          <div class="sentences-container" data-section="${sectionIndex}">
            ${renderSentences(section.sentences || [], sectionIndex)}
          </div>
        `;
        
        container.appendChild(card);
      });

      // Initialize sortable for sections (if Sortable is available)
      if (typeof Sortable !== 'undefined') {
        new Sortable(container, {
          animation: 150,
          handle: '.section-card-header',
          onEnd: (evt) => {
            const item = templateData.narrativeSections.splice(evt.oldIndex, 1)[0];
            templateData.narrativeSections.splice(evt.newIndex, 0, item);
            renderSections();
          }
        });

        // Initialize sortable for sentences within each section
        document.querySelectorAll('.sentences-container').forEach(cont => {
          new Sortable(cont, {
            animation: 150,
            handle: '.drag-handle',
            group: 'sentences',
            onEnd: (evt) => {
              const fromSection = parseInt(evt.from.dataset.section);
              const toSection = parseInt(evt.to.dataset.section);
              const item = templateData.narrativeSections[fromSection].sentences.splice(evt.oldIndex, 1)[0];
              templateData.narrativeSections[toSection].sentences.splice(evt.newIndex, 0, item);
              renderSections();
            }
          });
        });
      }
    }

    function renderSentences(sentences, sectionIndex) {
      if (!sentences || sentences.length === 0) {
        return '<p class="text-muted small">No sentences. Click + to add one.</p>';
      }
      
      return sentences.map((sentence, sentenceIndex) => {
        let badges = '';
        let content = '';
        
        if (sentence.QuickSentence) {
          badges = '<span class="badge badge-quicksentence me-1">QuickSentence</span>';
          content = `<div class="sentence-text">${escapeHtml(sentence.QuickSentence)}</div>`;
        } else if (sentence.tabs) {
          badges = '<span class="badge badge-tabbed me-1">Tabbed</span>';
          content = `<div class="mt-2">${sentence.tabs.map((tab, i) => `
            <div class="tab-item">
              <strong>${escapeHtml(tab.title || 'Tab ' + (i+1))}:</strong>
              <div class="sentence-text mt-1">${escapeHtml(tab.text || '')}</div>
            </div>
          `).join('')}</div>`;
        } else {
          const text = sentence.text || '';
          if (text.startsWith('++')) {
            badges = '<span class="badge badge-incremental me-1">++ Incremental</span>';
          } else if (text.startsWith('+')) {
            badges = '<span class="badge badge-incremental me-1">+ Incremental</span>';
          }
          content = `<div class="sentence-text">${escapeHtml(text)}</div>`;
        }
        
        return `
          <div class="sentence-item" data-index="${sentenceIndex}">
            <div class="sentence-item-header">
              <div class="d-flex align-items-start">
                <span class="drag-handle"><i class="bi bi-grip-vertical"></i></span>
                <div>${badges}</div>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary btn-sm" onclick="openSentenceModal(${sectionIndex}, ${sentenceIndex})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteSentence(${sectionIndex}, ${sentenceIndex})"><i class="bi bi-trash"></i></button>
              </div>
            </div>
            ${content}
          </div>
        `;
      }).join('');
    }

    function renderGlobalSentences() {
      const container = document.getElementById('globalSentencesContainer');
      container.innerHTML = '';
      
      if (!globalData.commonSentences || globalData.commonSentences.length === 0) {
        container.innerHTML = '<p class="text-muted">No global sentences defined. Click "Add Global Sentence" to create one.</p>';
        return;
      }
      
      globalData.commonSentences.forEach((sentence, index) => {
        const item = document.createElement('div');
        item.className = 'common-sentence-item';
        
        let badges = '';
        let content = '';
        
        if (typeof sentence === 'string') {
          content = `<div class="sentence-text">${escapeHtml(sentence)}</div>`;
        } else if (sentence.tabs) {
          badges = '<span class="badge badge-tabbed me-1">Tabbed</span>';
          if (sentence.name) badges = `<span class="badge bg-secondary me-1">${escapeHtml(sentence.name)}</span>` + badges;
          content = `<div class="mt-2">${sentence.tabs.map((tab, i) => `
            <div class="tab-item">
              <strong>${escapeHtml(tab.title || 'Tab ' + (i+1))}:</strong>
              <div class="sentence-text mt-1">${escapeHtml(tab.text || '')}</div>
            </div>
          `).join('')}</div>`;
        } else {
          const text = sentence.text || '';
          if (sentence.name) badges = `<span class="badge bg-secondary me-1">${escapeHtml(sentence.name)}</span>`;
          if (text.startsWith('++')) {
            badges += '<span class="badge badge-incremental me-1">++ Incremental</span>';
          } else if (text.startsWith('+')) {
            badges += '<span class="badge badge-incremental me-1">+ Incremental</span>';
          }
          content = `<div class="sentence-text">${escapeHtml(text)}</div>`;
        }
        
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>${badges}</div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary btn-sm" onclick="openGlobalSentenceModal(${index})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteGlobalSentence(${index})"><i class="bi bi-trash"></i></button>
            </div>
          </div>
          ${content}
        `;
        
        container.appendChild(item);
      });
    }

    function renderDropdowns(container, dropdowns, type) {
      container.innerHTML = '';
      
      const keys = Object.keys(dropdowns);
      if (keys.length === 0) {
        container.innerHTML = `<p class="text-muted">No ${type} dropdowns defined.</p>`;
        return;
      }
      
      keys.forEach(name => {
        const options = dropdowns[name];
        const item = document.createElement('div');
        item.className = 'common-sentence-item';
        
        const hiddenCount = options.filter(o => o.startsWith('*')).length;
        
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <strong>${escapeHtml(name)}</strong>
              <span class="badge bg-secondary ms-2">${options.length} options</span>
              ${hiddenCount > 0 ? `<span class="badge badge-hidden ms-1">${hiddenCount} hidden</span>` : ''}
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary btn-sm" onclick="openDropdownModal('${type}', '${escapeHtml(name)}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteDropdown('${type}', '${escapeHtml(name)}')"><i class="bi bi-trash"></i></button>
            </div>
          </div>
          <div class="small text-muted">
            ${options.slice(0, 5).map(o => `<code>${escapeHtml(o)}</code>`).join(', ')}
            ${options.length > 5 ? `<span class="text-muted">... and ${options.length - 5} more</span>` : ''}
          </div>
        `;
        
        container.appendChild(item);
      });
    }

    function renderLocalDropdowns() {
      renderDropdowns(document.getElementById('localDropdownsContainer'), templateData.localDropdownOptions, 'local');
    }

    function renderGlobalDropdowns() {
      renderDropdowns(document.getElementById('globalDropdownsContainer'), globalData.globalDropdownOptions, 'global');
    }

    function updatePreview() {
      document.getElementById('templateJsonPreview').textContent = JSON.stringify(templateData, null, 2);
      document.getElementById('globalJsonPreview').textContent = JSON.stringify(globalData, null, 2);
    }

    // ==================== SECTION OPERATIONS ====================
    function openSectionModal(index = null) {
      editingIndex = index;
      const modal = new bootstrap.Modal(document.getElementById('sectionModal'));
      
      document.getElementById('sectionModalTitle').textContent = index !== null ? 'Edit Section' : 'Add Section';
      
      if (index !== null) {
        const section = templateData.narrativeSections[index];
        document.getElementById('sectionPart').value = section.part || '';
        document.getElementById('sectionSubpart').value = section.subpart || '';
        document.getElementById('sectionTooltip').value = section.tooltip || '';
        document.getElementById('sectionIncludeTitle').checked = section.includeTitle !== false;
      } else {
        document.getElementById('sectionPart').value = '';
        document.getElementById('sectionSubpart').value = '';
        document.getElementById('sectionTooltip').value = '';
        document.getElementById('sectionIncludeTitle').checked = true;
      }
      
      modal.show();
    }

    function saveSection() {
      const part = document.getElementById('sectionPart').value.trim();
      if (!part) {
        alert('Part is required');
        return;
      }
      
      const section = {
        part: part,
        subpart: document.getElementById('sectionSubpart').value.trim() || undefined,
        tooltip: document.getElementById('sectionTooltip').value.trim() || undefined,
        includeTitle: document.getElementById('sectionIncludeTitle').checked,
        sentences: editingIndex !== null ? templateData.narrativeSections[editingIndex].sentences : []
      };
      
      // Clean undefined values
      Object.keys(section).forEach(key => section[key] === undefined && delete section[key]);
      
      if (editingIndex !== null) {
        templateData.narrativeSections[editingIndex] = section;
      } else {
        templateData.narrativeSections.push(section);
      }
      
      bootstrap.Modal.getInstance(document.getElementById('sectionModal')).hide();
      renderSections();
      updatePreview();
    }

    function deleteSection(index) {
      if (confirm('Are you sure you want to delete this section and all its sentences?')) {
        templateData.narrativeSections.splice(index, 1);
        renderSections();
        updatePreview();
      }
    }

    // ==================== SENTENCE OPERATIONS ====================
    function openSentenceModal(sectionIndex, sentenceIndex = null) {
      editingSectionIndex = sectionIndex;
      editingIndex = sentenceIndex;
      
      const modal = new bootstrap.Modal(document.getElementById('sentenceModal'));
      document.getElementById('sentenceModalTitle').textContent = sentenceIndex !== null ? 'Edit Sentence' : 'Add Sentence';
      
      // Reset form
      document.getElementById('sentenceText').value = '';
      document.getElementById('sentenceIncremental').checked = false;
      document.getElementById('sentenceIncrementalNewline').checked = false;
      document.getElementById('incrementalNewlineOption').style.display = 'none';
      document.getElementById('quickSentenceName').value = '';
      document.getElementById('tabsContainer').innerHTML = '';
      
      // Switch to simple tab by default
      const simpleTab = document.querySelector('[data-bs-target="#simpleTab"]');
      bootstrap.Tab.getOrCreateInstance(simpleTab).show();
      
      if (sentenceIndex !== null) {
        const sentence = templateData.narrativeSections[sectionIndex].sentences[sentenceIndex];
        
        if (sentence.QuickSentence) {
          const quickTab = document.querySelector('[data-bs-target="#quickTab"]');
          bootstrap.Tab.getOrCreateInstance(quickTab).show();
          document.getElementById('quickSentenceName').value = sentence.QuickSentence;
        } else if (sentence.tabs) {
          const tabbedTab = document.querySelector('[data-bs-target="#tabbedTab"]');
          bootstrap.Tab.getOrCreateInstance(tabbedTab).show();
          sentence.tabs.forEach(tab => addTabToEditor('tabsContainer', tab.title, tab.text));
        } else {
          let text = sentence.text || '';
          if (text.startsWith('++')) {
            document.getElementById('sentenceIncremental').checked = true;
            document.getElementById('sentenceIncrementalNewline').checked = true;
            document.getElementById('incrementalNewlineOption').style.display = 'block';
            text = text.substring(2);
          } else if (text.startsWith('+')) {
            document.getElementById('sentenceIncremental').checked = true;
            document.getElementById('incrementalNewlineOption').style.display = 'block';
            text = text.substring(1);
          }
          document.getElementById('sentenceText').value = text;
        }
      }
      
      modal.show();
    }

    function saveSentence() {
      const activeTab = document.querySelector('#sentenceTypeTabs .nav-link.active').dataset.bsTarget;
      let sentence = {};
      
      if (activeTab === '#simpleTab') {
        let text = document.getElementById('sentenceText').value.trim();
        if (!text) {
          alert('Sentence text is required');
          return;
        }
        if (document.getElementById('sentenceIncremental').checked) {
          text = (document.getElementById('sentenceIncrementalNewline').checked ? '++' : '+') + text;
        }
        sentence = { text };
      } else if (activeTab === '#tabbedTab') {
        const tabs = [];
        document.querySelectorAll('#tabsContainer .tab-editor-item').forEach(item => {
          const title = item.querySelector('.tab-title').value.trim();
          const text = item.querySelector('.tab-text').value.trim();
          if (title || text) {
            tabs.push({ title, text });
          }
        });
        if (tabs.length === 0) {
          alert('At least one tab is required');
          return;
        }
        sentence = { tabs };
      } else if (activeTab === '#quickTab') {
        const name = document.getElementById('quickSentenceName').value.trim();
        if (!name) {
          alert('QuickSentence name is required');
          return;
        }
        sentence = { QuickSentence: name };
      }
      
      if (!templateData.narrativeSections[editingSectionIndex].sentences) {
        templateData.narrativeSections[editingSectionIndex].sentences = [];
      }
      
      if (editingIndex !== null) {
        templateData.narrativeSections[editingSectionIndex].sentences[editingIndex] = sentence;
      } else {
        templateData.narrativeSections[editingSectionIndex].sentences.push(sentence);
      }
      
      bootstrap.Modal.getInstance(document.getElementById('sentenceModal')).hide();
      renderSections();
      updatePreview();
    }

    function deleteSentence(sectionIndex, sentenceIndex) {
      if (confirm('Are you sure you want to delete this sentence?')) {
        templateData.narrativeSections[sectionIndex].sentences.splice(sentenceIndex, 1);
        renderSections();
        updatePreview();
      }
    }

    // ==================== GLOBAL SENTENCE OPERATIONS ====================
    function openGlobalSentenceModal(index = null) {
      editingIndex = index;
      const modal = new bootstrap.Modal(document.getElementById('globalSentenceModal'));
      
      document.getElementById('globalSentenceModalTitle').textContent = index !== null ? 'Edit Global Sentence' : 'Add Global Sentence';
      
      // Reset form
      document.getElementById('globalSentenceName').value = '';
      document.getElementById('globalSentenceText').value = '';
      document.getElementById('globalSentenceIncremental').checked = false;
      document.getElementById('globalSentenceIncrementalNewline').checked = false;
      document.getElementById('globalIncrementalNewlineOption').style.display = 'none';
      document.getElementById('globalTabsContainer').innerHTML = '';
      
      const simpleTab = document.querySelector('[data-bs-target="#globalSimpleTab"]');
      bootstrap.Tab.getOrCreateInstance(simpleTab).show();
      
      if (index !== null) {
        const sentence = globalData.commonSentences[index];
        
        if (typeof sentence === 'string') {
          document.getElementById('globalSentenceText').value = sentence;
        } else {
          document.getElementById('globalSentenceName').value = sentence.name || '';
          
          if (sentence.tabs) {
            const tabbedTab = document.querySelector('[data-bs-target="#globalTabbedTab"]');
            bootstrap.Tab.getOrCreateInstance(tabbedTab).show();
            sentence.tabs.forEach(tab => addTabToEditor('globalTabsContainer', tab.title, tab.text));
          } else {
            let text = sentence.text || '';
            if (text.startsWith('++')) {
              document.getElementById('globalSentenceIncremental').checked = true;
              document.getElementById('globalSentenceIncrementalNewline').checked = true;
              document.getElementById('globalIncrementalNewlineOption').style.display = 'block';
              text = text.substring(2);
            } else if (text.startsWith('+')) {
              document.getElementById('globalSentenceIncremental').checked = true;
              document.getElementById('globalIncrementalNewlineOption').style.display = 'block';
              text = text.substring(1);
            }
            document.getElementById('globalSentenceText').value = text;
          }
        }
      }
      
      modal.show();
    }

    function saveGlobalSentence() {
      const name = document.getElementById('globalSentenceName').value.trim();
      const activeTab = document.querySelector('#globalSentenceTypeTabs .nav-link.active').dataset.bsTarget;
      let sentence;
      
      if (activeTab === '#globalSimpleTab') {
        let text = document.getElementById('globalSentenceText').value.trim();
        if (!text) {
          alert('Sentence text is required');
          return;
        }
        if (document.getElementById('globalSentenceIncremental').checked) {
          text = (document.getElementById('globalSentenceIncrementalNewline').checked ? '++' : '+') + text;
        }
        sentence = name ? { name, text } : { text };
      } else {
        const tabs = [];
        document.querySelectorAll('#globalTabsContainer .tab-editor-item').forEach(item => {
          const title = item.querySelector('.tab-title').value.trim();
          const text = item.querySelector('.tab-text').value.trim();
          if (title || text) {
            tabs.push({ title, text });
          }
        });
        if (tabs.length === 0) {
          alert('At least one tab is required');
          return;
        }
        sentence = name ? { name, tabs } : { tabs };
      }
      
      if (editingIndex !== null) {
        globalData.commonSentences[editingIndex] = sentence;
      } else {
        globalData.commonSentences.push(sentence);
      }
      
      bootstrap.Modal.getInstance(document.getElementById('globalSentenceModal')).hide();
      renderGlobalSentences();
      updatePreview();
    }

    function deleteGlobalSentence(index) {
      if (confirm('Are you sure you want to delete this global sentence?')) {
        globalData.commonSentences.splice(index, 1);
        renderGlobalSentences();
        updatePreview();
      }
    }

    // ==================== DROPDOWN OPERATIONS ====================
    function openDropdownModal(type, name = null) {
      editingDropdownType = type;
      editingDropdownName = name;
      
      const modal = new bootstrap.Modal(document.getElementById('dropdownModal'));
      document.getElementById('dropdownModalTitle').textContent = name ? 'Edit Dropdown' : 'Add Dropdown';
      
      document.getElementById('dropdownName').value = name || '';
      document.getElementById('dropdownName').disabled = !!name;
      document.getElementById('dropdownOptionsContainer').innerHTML = '';
      
      if (name) {
        const options = type === 'local' ? templateData.localDropdownOptions[name] : globalData.globalDropdownOptions[name];
        if (options) {
          options.forEach(opt => addDropdownOption(opt));
        }
      } else {
        addDropdownOption();
      }
      
      modal.show();
    }

    function addDropdownOption(value = '') {
      const container = document.getElementById('dropdownOptionsContainer');
      const item = document.createElement('div');
      item.className = 'dropdown-option-item';
      item.innerHTML = `
        <div class="form-check">
          <input type="checkbox" class="form-check-input option-hidden" ${value.startsWith('*') ? 'checked' : ''} title="Hidden by default">
        </div>
        <input type="text" class="form-control form-control-sm option-value" value="${escapeHtml(value.replace(/^\*/, ''))}" placeholder="Option value">
        <button class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button>
      `;
      container.appendChild(item);
    }

    function saveDropdown() {
      const name = document.getElementById('dropdownName').value.trim();
      if (!name) {
        alert('Dropdown name is required');
        return;
      }
      
      const options = [];
      document.querySelectorAll('#dropdownOptionsContainer .dropdown-option-item').forEach(item => {
        const value = item.querySelector('.option-value').value.trim();
        const hidden = item.querySelector('.option-hidden').checked;
        if (value) {
          options.push(hidden ? '*' + value : value);
        }
      });
      
      if (options.length === 0) {
        alert('At least one option is required');
        return;
      }
      
      if (editingDropdownType === 'local') {
        if (editingDropdownName && editingDropdownName !== name) {
          delete templateData.localDropdownOptions[editingDropdownName];
        }
        templateData.localDropdownOptions[name] = options;
        renderLocalDropdowns();
      } else {
        if (editingDropdownName && editingDropdownName !== name) {
          delete globalData.globalDropdownOptions[editingDropdownName];
        }
        globalData.globalDropdownOptions[name] = options;
        renderGlobalDropdowns();
      }
      
      bootstrap.Modal.getInstance(document.getElementById('dropdownModal')).hide();
      updatePreview();
    }

    function deleteDropdown(type, name) {
      if (confirm(`Are you sure you want to delete the "${name}" dropdown?`)) {
        if (type === 'local') {
          delete templateData.localDropdownOptions[name];
          renderLocalDropdowns();
        } else {
          delete globalData.globalDropdownOptions[name];
          renderGlobalDropdowns();
        }
        updatePreview();
      }
    }

    // ==================== TAB EDITOR HELPERS ====================
    function addTabToEditor(containerId, title = '', text = '') {
      const container = document.getElementById(containerId);
      const item = document.createElement('div');
      item.className = 'tab-editor-item tab-item mb-2';
      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <input type="text" class="form-control form-control-sm tab-title" placeholder="Tab title" value="${escapeHtml(title)}" style="max-width: 200px;">
          <button class="btn btn-outline-danger btn-sm" onclick="this.closest('.tab-editor-item').remove()"><i class="bi bi-trash"></i></button>
        </div>
        <textarea class="form-control form-control-sm tab-text" rows="3" placeholder="Tab content with placeholders...">${escapeHtml(text)}</textarea>
        <div class="mt-2">
          <small class="text-muted">Insert:</small>
          <button class="btn btn-outline-secondary insert-btn" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" onclick="insertAtCursor(this.closest('.tab-editor-item').querySelector('.tab-text'), '[text:Label]')">Text</button>
          <button class="btn btn-outline-secondary insert-btn" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" onclick="insertAtCursor(this.closest('.tab-editor-item').querySelector('.tab-text'), '[customDropdown:Label]')">Dropdown</button>
          <button class="btn btn-outline-secondary insert-btn" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;" onclick="insertAtCursor(this.closest('.tab-editor-item').querySelector('.tab-text'), '[+]')">Incremental</button>
        </div>
      `;
      container.appendChild(item);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function insertAtCursor(textarea, text) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      textarea.value = before + text + after;
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
      textarea.focus();
    }
  </script>
</body>
</html>
