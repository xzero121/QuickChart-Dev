<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oxygen Duration Calculator</title>
  <style>
    /* Minimal structural styles - colors handled by parent when loaded in modal */
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .bubbleRow { display:flex; gap:10px; margin-top: 12px; }
    .bubble { flex: 1; text-align: center; }
    .comboWrap { position: relative; }
    .comboInput { padding-right: 38px; }
    .comboBtn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      display: grid;
      place-items: center;
      user-select: none;
      cursor: pointer;
    }    
    .dropdown {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      overflow-y: auto;
      display: none;
      z-index: 1000;
      max-height: 200px;
      background: #fff;
      border: 1px solid #ced4da;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.10);
    }
    .dropdown.open { display: block; }    
    .dropdownItem {
      padding: 10px 12px;
      cursor: pointer;
      display: grid;
      grid-template-columns: 50px 1fr !important;
      align-items: center;
      gap: 12px;
    }
    .dropdownItem > span:first-child {
      text-align: left;
    }
    .dropdownItem > span:last-child {
      text-align: right;
      white-space: nowrap;
    }
    #ventilatorDisclaimer {
      display: none;
      background-color: #e9ecef;
      border-left: 4px solid #6c757d;
      padding: 10px 12px;
      margin-bottom: 12px;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #495057;
      font-weight: 500;
    }
    #ventilatorDisclaimer.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="card">
    <div id="ventilatorDisclaimer" style="display: none;" class="text-center">⚠️ Experimental! Use with Caution!</div>
    <h2 style="margin:0 0 6px; text-align:center;">Oxygen Duration Calculator</h2>
    
    <div class="modeContainer">
      <div class="tankSizeWrapper">
        <label for="tankSize">Tank Size</label>
        <select id="tankSize">
          <option value="D" selected>Portable - Class D (M-15)</option>
          <option value="E">Large Portable - Class E (M-22)</option>
          <option value="M">Main - Class M (M-122)</option>
          <option value="H">Large Main - Class H (M-250)</option>
        </select>
      </div>
      
      <div class="modeToggleWrapper">
        <label>&nbsp;</label>
        <button id="modeToggleBtn" type="button" class="btn btn-outline-secondary" style="width: 100%;">
          <i class="bi bi-lightning-fill"></i> Ventilator Mode
        </button>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="currentPSIInput">Current PSI</label>
        <div class="comboWrap">
          <input id="currentPSIInput" class="comboInput" type="text" placeholder="e.g. 2000" autocomplete="off" />
          <div id="currentPSIBtn" class="comboBtn">▾</div>

          <div id="currentPSIDropdown" class="dropdown"></div>
        </div>
      </div>

      <div id="flowRateWrapper">
        <label for="flowRateInput">Flow Rate (LPM)</label>
        <div class="comboWrap">
          <input id="flowRateInput" class="comboInput" type="text" placeholder="e.g. 15" autocomplete="off" />
          <div id="flowRateBtn" class="comboBtn">▾</div>

          <div id="flowRateDropdown" class="dropdown"></div>
        </div>
      </div>

      <div id="fio2Wrapper" style="display: none;">
        <label for="fio2Input">FiO2 (%)</label>
        <input id="fio2Input" type="text" placeholder="e.g. 40" autocomplete="off" />
      </div>
    </div>

    <div id="ventilatorRow" class="ventilatorRow" style="display: none;">
      <div>
        <label for="volumeInput">Tidal Volume (mL)</label>
        <input id="volumeInput" type="text" placeholder="e.g. 500" autocomplete="off" />
      </div>
      <div>
        <label for="rrInput">Respiration Rate (breaths/min)</label>
        <input id="rrInput" type="text" placeholder="e.g. 12" autocomplete="off" />
      </div>
    </div>

    <button id="calcBtn" type="button">Calculate</button>

    <div id="result"></div>
  </div>

  <script src="./calcs.js"></script>
  <script>
    const el = (id) => document.getElementById(id);
    const resultBox = el("result");    const PSI_VALUES = Array.from({ length: 25 }, (_, i) => (i + 1) * 100);
    const FLOW_RATE_VALUES = [0.25, 0.5, 0.75, 1, 2, 3, 4, 5, 6, 8, 10, 12.5, 15, 25];

    const tankSize = el("tankSize");
    const currentPSIInput = el("currentPSIInput");
    const currentPSIBtn = el("currentPSIBtn");
    const currentPSIDropdown = el("currentPSIDropdown");

    const flowRateInput = el("flowRateInput");
    const flowRateBtn = el("flowRateBtn");
    const flowRateDropdown = el("flowRateDropdown");
    const flowRateWrapper = el("flowRateWrapper");

    const modeToggleBtn = el("modeToggleBtn");
    const fio2Wrapper = el("fio2Wrapper");
    const ventilatorRow = el("ventilatorRow");
    const ventilatorDisclaimer = el("ventilatorDisclaimer");
    const volumeInput = el("volumeInput");
    const rrInput = el("rrInput");
    const fio2Input = el("fio2Input");

    let isVentilatorMode = false;

    function showError(msg) {
      resultBox.innerHTML = `<div class="err"><strong>Error:</strong> ${msg}</div>`;
    }

    function showResult(minutes, safeMinutes) {
      const hours = Math.floor(minutes / 60);
      const mins = Math.round(minutes % 60);
      if (hours > 0) {
        return `${hours}h ${mins}m`;
      } else {
        return `${mins}m`;
      }
    }

    function showResult(result) {
      const safeStr = formatDuration(result.safe);
      const maxStr = formatDuration(result.max);

      const safeHours = Math.floor(safeMinutes / 60);
      const safeMins = Math.round(safeMinutes % 60);
      let timeSafeStr = "";
      if (safeHours > 0) {
        timeSafeStr = `${safeHours}h ${safeMins}m`;
      } else {
        timeSafeStr = `${safeMins}m`;
      }

      resultBox.innerHTML = `
        <div class="bubbleRow">
          <div class="bubble">
            <div class="bubbleTitle">Duration</div>
            <div class="bubbleValue${safeMinutes <= 5 ? " o2-warn": ""}">${safeMinutes > 0 ? timeSafeStr : "0m"}</div>
            <div class="bubbleSubtitle">Max: ${timeStr}</div>
          </div>
        </div>`;
    }

    function parseNumber(input, label) {
      const match = input.value.match(/(\d+(\.\d+)?)/);
      const n = match ? Number(match[1]) : NaN;
      if (!Number.isFinite(n) || n <= 0) throw new Error(`Enter a valid ${label}.`);
      return n;
    }    function buildPSIDropdown() {
      currentPSIDropdown.innerHTML = PSI_VALUES.map(v => `
        <div class="dropdownItem" data-value="${v}">
          <span>${v}</span>
          <span class="itemHint">PSI</span>
        </div>
      `).join("");
    }    function buildFlowRateDropdown() {
      flowRateDropdown.innerHTML = FLOW_RATE_VALUES.map(v => `
        <div class="dropdownItem" data-value="${v}">
          <span>${v}</span>
          <span class="itemHint">LPM</span>
        </div>
      `).join("");
    }

    currentPSIBtn.onclick = () => currentPSIDropdown.classList.toggle("open");
    flowRateBtn.onclick = () => flowRateDropdown.classList.toggle("open");

    currentPSIDropdown.onclick = (e) => {
      const item = e.target.closest(".dropdownItem");
      if (!item) return;
      currentPSIInput.value = item.dataset.value;
      currentPSIDropdown.classList.remove("open");
    };

    flowRateDropdown.onclick = (e) => {
      const item = e.target.closest(".dropdownItem");
      if (!item) return;
      flowRateInput.value = item.dataset.value;
      flowRateDropdown.classList.remove("open");
    };

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".comboWrap")) {
        currentPSIDropdown.classList.remove("open");
        flowRateDropdown.classList.remove("open");
      }
    });

    // Mode toggle handler
    modeToggleBtn.onclick = () => {
      isVentilatorMode = !isVentilatorMode;
      
      // Toggle visibility - swap Flow Rate with FiO2
      flowRateWrapper.style.display = isVentilatorMode ? "none" : "block";
      fio2Wrapper.style.display = isVentilatorMode ? "block" : "none";
      ventilatorRow.style.display = isVentilatorMode ? "flex" : "none";
      ventilatorDisclaimer.style.display = isVentilatorMode ? "block" : "none";
      
      // Toggle button styling
      if (isVentilatorMode) {
        modeToggleBtn.classList.add("btn-secondary");
        modeToggleBtn.classList.remove("btn-outline-secondary");
      } else {
        modeToggleBtn.classList.add("btn-outline-secondary");
        modeToggleBtn.classList.remove("btn-secondary");
      }
    };

    // Defaults
    currentPSIInput.value = "2000";
    flowRateInput.value = "15";
    buildPSIDropdown();
    buildFlowRateDropdown();

    el("calcBtn").onclick = () => {
      resultBox.innerHTML = "";

      let duration, safeDuration;

      // check if vent mode is toggled
      if (isVentilatorMode) {

        let fio2, volume, rr, tankSizeVal, currentPSI;
        try {
          tankSizeVal = tankSize.value.trim().toUpperCase();
          if (!["D", "E", "M", "H"].includes(tankSizeVal)) {
            throw new Error("Tank size must be D, E, M, or H.");
          }
          fio2 = parseNumber(fio2Input, "FiO2");
          volume = parseNumber(volumeInput, "Tidal Volume");
          rr = parseNumber(rrInput, "Respiration Rate");
          if (fio2 < 21 || fio2 > 100) {
            throw new Error("FiO2 must be between 21 and 100.");
          }
          currentPSI = parseNumber(currentPSIInput, "current PSI");
        } catch (e) {
          return showError(e.message);
        }

      if (typeof calculateOxygenDurationVent !== "function") {
        return showError("calculateOxygenDurationVent() not found.");
      }

        ({ duration, safeDuration } = calculateOxygenDurationVent(tankSizeVal, currentPSI, fio2, volume, rr));
      }
      else
      {
        
      let tankSizeVal, currentPSI, flowRate;
      try {
        tankSizeVal = tankSize.value.trim().toUpperCase();
        if (!["D", "E", "M", "H"].includes(tankSizeVal)) {
          throw new Error("Tank size must be D, E, M, or H.");
        }
        currentPSI = parseNumber(currentPSIInput, "current PSI");
        flowRate = parseNumber(flowRateInput, "flow rate");
      } catch (e) {
        return showError(e.message);
      }

      if (typeof calculateOxygenDuration !== "function") {
        return showError("calculateOxygenDuration() not found.");
      }

      ({ duration, safeDuration } = calculateOxygenDuration(tankSizeVal, currentPSI, flowRate));
      }
      showResult(duration, safeDuration);
    };
  </script>
</body>
</html>
